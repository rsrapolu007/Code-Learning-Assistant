from flask import Flask, request, jsonify
import subprocess
import tempfile
import os

app = Flask(__name__)

@app.route("/run", methods=["POST"])
def run_code():
    data = request.get_json()
    code = data.get("code", "")

    try:
        with tempfile.NamedTemporaryFile(delete=False, suffix=".py", mode='w') as tmp:
            tmp.write(code)
            tmp_filename = tmp.name

        result = subprocess.run(
            ["python3", tmp_filename],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            timeout=5
        )

        output = result.stdout.decode() + result.stderr.decode()
        os.unlink(tmp_filename)
        return jsonify({"output": output})
    
    except subprocess.TimeoutExpired:
        return jsonify({"output": "Error: Code execution timed out."})
    
    except Exception as e:
        return jsonify({"output": f"Error: {str(e)}"})

if __name__ == "__main__":
    app.run(debug=True)
